name: Reset to Base

on:
  workflow_dispatch:  # Solo se ejecuta manualmente desde la pesta√±a "Actions"

jobs:
  reset:
    name: Clean migrated files and preserve base
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Show warning and confirmation
        run: |
          echo "‚ö†Ô∏è  Este flujo eliminar√° todos los archivos migrados y dejar√° solo los archivos base."
          echo "‚ö†Ô∏è  No se modificar√° el contenido de los archivos base:"
          echo "   - src/app.js"
          echo "   - src/server.js"
          echo "   - .github/workflows/run-and-check.yml"
          echo "   - .github/workflows/reset-to-base.yml"
          echo "   - package.json"
          echo "   - package-lock.json"
          echo ""
          echo "Presiona 'Run workflow' con precauci√≥n desde GitHub Actions."
          sleep 5

      - name: Remove migrated folders and files
        run: |
          echo "üßπ Eliminando todos los archivos migrados (preservando solo la base)..."

          # Elimina TODO excepto los archivos base definidos
          find . -mindepth 1 -maxdepth 1 ! -path './.github' ! -name 'src' ! -name 'package.json' ! -name 'package-lock.json' -exec rm -rf {} +

          # Dentro de src, eliminar todo excepto app.js y server.js
          if [ -d "src" ]; then
            find src -mindepth 1 -type f ! -name 'app.js' ! -name 'server.js' -delete
            find src -mindepth 1 -type d -exec rm -rf {} +
          fi

          # Dentro de .github/workflows, mantener los dos YAMLs base
          if [ -d ".github/workflows" ]; then
            find .github/workflows -type f ! -name 'run-and-check.yml' ! -name 'reset-to-base.yml' -delete
          fi

          echo "‚úÖ Migraciones eliminadas, base preservada intacta."

      - name: Verify essential files exist
        run: |
          echo "üîç Verificando archivos esenciales..."
          REQUIRED_FILES=(
            "src/app.js"
            "src/server.js"
            ".github/workflows/run-and-check.yml"
            ".github/workflows/reset-to-base.yml"
            "package.json"
            "package-lock.json"
          )

          for f in "${REQUIRED_FILES[@]}"; do
            if [ ! -f "$f" ]; then
              echo "::error::Falta el archivo esencial: $f"
              exit 1
            fi
          done
          echo "‚úÖ Todos los archivos esenciales est√°n presentes."

      - name: Git commit and push cleanup
        run: |
          git config user.name "Reset Bot"
          git config user.email "bot@example.com"
          git add -A
          git commit -m "Reset to base (keep core files only) [skip ci]" || echo "No changes to commit"
          git push

      - name: Confirm cleanup summary
        run: |
          echo "üöÄ Limpieza completada correctamente."
          echo "El repositorio mantiene solo los archivos base:"
          echo " - src/app.js"
          echo " - src/server.js"
          echo " - .github/workflows/run-and-check.yml"
          echo " - .github/workflows/reset-to-base.yml"
          echo " - package.json"
          echo " - package-lock.json"
          echo ""
          echo "Puedes volver a ejecutar la migraci√≥n en n8n desde cero con un entorno totalmente limpio."
